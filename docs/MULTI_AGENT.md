# DeskJarvis 多代理协作系统

## 概述

DeskJarvis 使用 CrewAI 框架实现多代理协作，让 AI 像团队一样工作，显著提高复杂任务的成功率。

## 架构

```
┌─────────────────────────────────────────────────────────────┐
│                     用户指令                                  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   任务复杂度分析                               │
│              TaskComplexityAnalyzer                         │
└─────────────────────────────────────────────────────────────┘
                            │
              ┌─────────────┴─────────────┐
              ▼                           ▼
    ┌─────────────────┐         ┌─────────────────┐
    │   简单任务       │         │   复杂任务       │
    │  单代理模式      │         │  多代理模式      │
    └─────────────────┘         └─────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────┐
│                      CrewManager                            │
│                                                             │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐              │
│  │  Planner  │→│  Executor │→│ Summarizer│              │
│  │   Agent   │  │   Agent   │  │   Agent   │              │
│  └───────────┘  └───────────┘  └───────────┘              │
│        ↑                                                    │
│        │         失败时触发                                  │
│        │              │                                     │
│  ┌───────────┐  ┌───────────┐                              │
│  │  Reviser  │←│ Reflector │                              │
│  │   Agent   │  │   Agent   │                              │
│  └───────────┘  └───────────┘                              │
└─────────────────────────────────────────────────────────────┘
```

## Agent 角色

### 1. Planner Agent（规划代理）

**职责**：分析用户指令，制定执行计划

- 将复杂任务分解为可执行步骤
- 确定步骤执行顺序和依赖关系
- 识别危险操作，标记需确认的步骤

**特点**：
- 不执行任何工具，只规划
- 输出结构化的步骤列表

### 2. Executor Agent（执行代理）

**职责**：执行具体操作

- 调用工具（截图、文件读写等）
- 生成并执行 Python 脚本
- 处理执行过程中的小错误

**可用工具**：
- `screenshot_desktop` - 桌面截图
- `file_read` - 读取文件
- `file_write` - 写入文件
- `execute_python` - 执行 Python 脚本
- `open_app` - 打开应用

### 3. Reflector Agent（反思代理）

**职责**：分析失败原因

- 检查错误日志
- 识别错误类型（语法、参数、逻辑、环境）
- 给出具体修复建议

**输出格式**：
```
## 错误分析
- 错误类型：[类型]
- 错误位置：[位置]
- 错误原因：[原因]

## 修复建议
1. [操作1]
2. [操作2]
```

### 4. Reviser Agent（修订代理）

**职责**：根据反思建议修正方案

- 最小改动原则，只改必要部分
- 不破坏正确的逻辑
- 验证修改后的语法正确

### 5. Summarizer Agent（总结代理）

**职责**：总结结果，输出给用户

- 用自然语言描述完成了什么
- 语言亲切，像朋友对话
- 失败时解释原因，给建议

## 使用方式

### 自动切换

系统会根据任务复杂度自动选择模式：

| 任务类型 | 判断条件 | 使用模式 |
|---------|---------|---------|
| 简单任务 | "截图"、"打开"、"关闭" 等 | 单代理模式 |
| 普通任务 | 50 字以内，无明显复杂关键词 | 单代理模式 |
| 复杂任务 | 包含 "批量"、"分析"、"整理" 等 | 多代理模式 |

### 手动配置

在代码中可以强制指定模式：

```python
# 初始化时指定
agent = DeskJarvisAgent(config, use_crew=True)  # 启用多代理
agent = DeskJarvisAgent(config, use_crew=False) # 禁用多代理
```

## 前端显示

### 进度面板

多代理模式下，进度面板会显示：

1. **多代理指示器**：显示当前活动的 Agent
2. **Agent 图标**：每个 Agent 有独特颜色标识
3. **日志标注**：日志条目标注来源 Agent

### Agent 颜色编码

| Agent | 颜色 |
|-------|------|
| Planner | 紫色 |
| Executor | 蓝色 |
| Reflector | 黄色 |
| Reviser | 橙色 |
| Summarizer | 绿色 |
| System | 灰色 |
| Crew | 靛蓝色 |

## 执行流程

### 正常流程

```
1. 用户发送指令
2. TaskComplexityAnalyzer 分析复杂度
3. 如果是复杂任务，创建 CrewManager
4. Planner 分析并制定计划
5. Executor 执行每个步骤
6. Summarizer 总结结果
7. 返回给用户
```

### 失败重试流程

```
1. Executor 执行失败
2. Reflector 分析错误原因
3. Reviser 修正方案
4. Executor 重新执行（最多 3 次）
5. 如果仍失败，返回错误信息
```

## 配置

### LLM 配置

CrewAI 支持多种 LLM 提供商：

- **DeepSeek**（默认）
- **Claude**
- **OpenAI**
- **Grok**

配置通过 `config.json` 的 `provider` 和 `model` 字段控制。

### Token 消耗

| 场景 | 预估 Token |
|------|-----------|
| 单次 Agent 调用 | 500-1000 |
| 完整复杂任务 | 3000-6000 |
| 失败重试（3次） | 5000-10000 |

## 最佳实践

1. **简单任务用单代理**：避免不必要的 token 消耗
2. **复杂任务用多代理**：提高成功率
3. **观察日志**：了解各 Agent 的工作状态
4. **适时介入**：如果 3 次重试仍失败，考虑手动处理

## 故障排除

### CrewAI 不可用

如果 CrewAI 未安装或初始化失败，系统会自动回退到单代理模式。

检查方法：
```python
from agent.crew import CREWAI_AVAILABLE
print(f"CrewAI 可用: {CREWAI_AVAILABLE}")
```

### 安装依赖

```bash
pip install crewai crewai-tools
```

### 常见问题

1. **多代理模式很慢**：正常，多 Agent 协作需要更多时间
2. **Token 消耗高**：可以调低 `max_iter` 参数
3. **某个 Agent 一直失败**：检查 LLM API 配置
